<!doctype html>
<html>
  <head>
    <title>GEN-SLATER</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='main.css') }}"
    />
  </head>
  <body>
    <div class="header">
      <div class="GEN-SLATER">GEN-SLATER</div>
    </div>
    <div class="chat-container">
    </div>
    <div class="message-input-container">
      <form action="/chat" method="post">
        <select id="generation-select" name="generation">
          <option value="Millennials">Millennials</option>
          <option value="Generation Z">Gen Z</option>
          <option value="Generation Alpha">Gen Alpha</option>
          <option value="Baby Boomers">Baby Boomers</option>
          <option value="Generation Beta">Gen Beta</option>
        </select>
        <textarea
          name="message"
          placeholder="Type your text to translate..."
          required
        ></textarea>
        <div class="button-group">
          <button type="submit" id="send-btn">&#x2191;</button>
        </div>
      </form>
    </div>
    <script>
      const chatContainer = document.querySelector(".chat-container");
      const form = document.querySelector("form");
      const messageInput = document.querySelector('textarea[name="message"]');

      function scrollToBottom() {
        // Scroll container and page to bottom to keep latest message in view
        chatContainer.scrollTop = chatContainer.scrollHeight;
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      }

      // Submit on Enter (Shift+Enter keeps newline)
      messageInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          form.requestSubmit();
        }
      });

      form.addEventListener("submit", function (event) {
          event.preventDefault();
          const generationSelect = document.getElementById("generation-select");
          const message = messageInput.value.trim();
          const generation = generationSelect.value;
          // chatContainer already defined above

          // Don't clear previous chat - keep history

          // Append the user's message to the chat container
          if (message) {
            const roleDiv = document.createElement("div");
            roleDiv.classList.add("message-role");
            roleDiv.classList.add("user");

            roleDiv.textContent = "PROMPT";
            chatContainer.appendChild(roleDiv);

            const userMessageDiv = document.createElement("div");
            userMessageDiv.classList.add("user-message");
            userMessageDiv.textContent = message;
            chatContainer.appendChild(userMessageDiv);

            scrollToBottom();
          }

          // Clear the message input
          messageInput.value = "";

          // Send the user's message and generation to the server using AJAX
          fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: message, generation: generation }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const roleDiv = document.createElement("div");
                roleDiv.classList.add("message-role");
                roleDiv.classList.add("assistant");

                roleDiv.textContent = "RESULTS ";
                
                const generationTag = document.createElement("span");
                generationTag.classList.add("generation-tag");
                generationTag.textContent = generation;
                
                roleDiv.appendChild(generationTag);
                chatContainer.appendChild(roleDiv);

                scrollToBottom();

                // Prepare the assistant's message container
                const assistantMessageDiv = document.createElement("div");
                assistantMessageDiv.classList.add("assistant-message");
                chatContainer.appendChild(assistantMessageDiv);

                scrollToBottom();

                // Open a connection to receive streamed responses
                const eventSource = new EventSource("/stream");
                eventSource.onmessage = function (event) {
                  const currentText = assistantMessageDiv.textContent;
                  const newText = event.data;
                  const lastChar = currentText.slice(-1);

                  // Check if we need to add a space (streamed chunks might be missing it)
                  if (/[.,!?]/.test(lastChar) && newText.charAt(0) !== " ") {
                    assistantMessageDiv.textContent += " " + newText;
                  } else {
                    assistantMessageDiv.textContent += newText;
                  }

                  // Scroll to the bottom of the chat container
                  chatContainer.scrollTop = chatContainer.scrollHeight;
                };
                eventSource.onerror = function () {
                  eventSource.close();
                };
              }
            });
        });
    </script>
  </body>
</html>
