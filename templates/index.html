<!doctype html>
<html>
  <head>
    <title>GEN-SLATER</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='main.css') }}"
    />
  </head>
  <body>
    <div class="header">
      <div class="logo">GEN-SLATER</div>
    </div>
    <div class="container">
      <div class="card">
        <div class="card-header">
          <select id="generation-select">
            <option value="Millennials">Millennials</option>
            <option value="Generation Z">Gen Z</option>
            <option value="Generation Alpha">Gen Alpha</option>
            <option value="Baby Boomers">Baby Boomers</option>
            <option value="Generation Beta">Gen Beta</option>
          </select>
        </div>
        <div class="card-body">
          <div class="section">
            <textarea
              id="input-text"
              placeholder="Enter text"
              rows="10"
            ></textarea>
            <div class="section-footer">
              <button id="translate-btn">Translate</button>
            </div>
          </div>
          <div class="section">
            <div id="output-text" class="section-content placeholder">Translation will appear here</div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const form = document.querySelector("form");
      const inputText = document.getElementById("input-text");
      const outputText = document.getElementById("output-text");
      const translateBtn = document.getElementById("translate-btn");
      const generationSelect = document.getElementById("generation-select");
      // Translate on button click
      translateBtn.addEventListener("click", function (event) {
        event.preventDefault();
        const message = inputText.value.trim();
        const generation = generationSelect.value;

        if (!message) {
          return;
        }

        // Show loading state
        outputText.textContent = "Translating...";
        translateBtn.disabled = true;

        // Send the user's message and generation to the server using AJAX
        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: message, generation: generation }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Clear the output and remove placeholder styling
              outputText.textContent = "";
              outputText.classList.remove("placeholder");

              // Open a connection to receive streamed responses
              const eventSource = new EventSource("/stream");
              eventSource.onmessage = function (event) {
                const currentText = outputText.textContent;
                const newText = event.data;
                const lastChar = currentText.slice(-1);

                // Check if we need to add a space (streamed chunks might be missing it)
                if (/[.,!?]/.test(lastChar) && newText.charAt(0) !== " ") {
                  outputText.textContent += " " + newText;
                } else {
                  outputText.textContent += newText;
                }
              };
              eventSource.onerror = function () {
                eventSource.close();
                translateBtn.disabled = false;
              };
            }
          })
          .catch((error) => {
            outputText.textContent = "Error translating text. Please try again.";
            translateBtn.disabled = false;
          });
      });

      // Submit on Ctrl+Enter
      inputText.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && event.ctrlKey) {
          event.preventDefault();
          translateBtn.click();
        }
      });
    </script>
  </body>
</html>
